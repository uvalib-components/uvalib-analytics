<link rel="import" href="../polymer/polymer.html">

<dom-module id="uvalib-analytics">
  <script>
    var _paq = _paq || [];
    _paq.push(['enableLinkTracking']);

    Polymer({
      is: 'uvalib-analytics',
      properties: {
        siteId: {
          type: Number,
          value: null
        },
        path: {
          type: String,
          value: null,
          observer: 'pathChanged'
        }
      },
      ready: function(){
        this.pathChanged();
        this._init();
      },
      /**
       * Called when the urls path has changed, calls piwiks trackPageView method
       * This is called automatically whenever this elements path attribute changes
       **/
      pathChanged: function(){
        // wait up to a second for any page changeing to settle down before counting this as a view
        this.debounce('pagechange', function(){
          if (this.path)
            _paq.push(['setCustomUrl', document.location.origin+this.path ]);
          _paq.push(['trackPageView']);
        }, 1000);
      },

      _init: function(){
        if (this.siteId) {
          var u="//analytics.lib.virginia.edu/";
          _paq.push(['setTrackerUrl', u+'piwik.php']);
          _paq.push(['setSiteId', this.siteId]);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
        }
      }
    });
  </script>
</dom-module>
